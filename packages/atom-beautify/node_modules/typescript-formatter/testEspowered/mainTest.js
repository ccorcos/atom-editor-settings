var assert = require('power-assert');
var Q = require('q');
var fs = require('fs');
var path = require('path');
var childProcess = require('child_process');
var lib = require('../lib/lib');
function collectFileName(dirName) {
    var fileName = [];
    fs.readdirSync(dirName).forEach(function (name) {
        var newName = dirName + '/' + name;
        var stats = fs.statSync(newName);
        if (stats.isDirectory()) {
            fileName = fileName.concat(collectFileName(newName));
        } else if (stats.isFile()) {
            fileName.push(newName);
        }
    });
    return fileName;
}
function checkByTslint(configFileName, tsfileName, errorExpected) {
    var d = Q.defer();
    var process = childProcess.spawn('./node_modules/.bin/tslint', [
            '-c',
            configFileName,
            '-f',
            tsfileName
        ]);
    var stdout = '';
    process.stdout.on('data', function (data) {
        stdout += data.toString();
    });
    var stderr = '';
    process.stderr.on('data', function (data) {
        stderr += data.toString();
    });
    process.on('exit', function (code) {
        var success = !code;
        var action;
        if (!errorExpected) {
            if (success) {
                action = 'resolve';
                d.resolve(true);
            } else {
                action = 'reject';
                d.reject(tsfileName + ' must be a good code.\n' + stdout);
            }
        } else {
            if (success) {
                action = 'reject';
                d.reject(tsfileName + ' must be a bad code.');
            } else {
                action = 'resolve';
                d.resolve(true);
            }
        }
    });
    return d.promise;
}
describe('tsfmt test', function () {
    var fixtureDir = './tests/fixture';
    var expectedDir = './tests/expected';
    describe('processFiles function', function () {
        var fileNames = collectFileName(fixtureDir);
        fileNames.filter(function (fileName) {
            return /\.ts$/.test(fileName);
        }).forEach(function (fileName) {
            it(fileName, function (done) {
                var resultMap = lib.processFiles([fileName], {
                        dryRun: true,
                        replace: false,
                        tslint: true,
                        editorconfig: true,
                        tsfmt: true
                    });
                var result = resultMap[fileName];
                assert(assert._expr(assert._capt(assert._capt(result, 'arguments/0/left') !== null, 'arguments/0'), {
                    content: 'assert(result !== null)',
                    filepath: 'tests/mainTest.js',
                    line: 80
                }));
                var expectedTsFileName = fileName.replace(fixtureDir, expectedDir);
                if (!fs.existsSync(expectedTsFileName)) {
                    fs.writeFileSync(expectedTsFileName, result.dest);
                }
                var expected = fs.readFileSync(expectedTsFileName, 'utf-8');
                assert(assert._expr(assert._capt(assert._capt(expected, 'arguments/0/left') === assert._capt(assert._capt(result, 'arguments/0/right/object').dest, 'arguments/0/right'), 'arguments/0'), {
                    content: 'assert(expected === result.dest)',
                    filepath: 'tests/mainTest.js',
                    line: 89
                }));
                var expectedOptionsFileName = expectedTsFileName.replace(/\.ts$/, '.json');
                if (!fs.existsSync(expectedOptionsFileName)) {
                    fs.writeFileSync(expectedOptionsFileName, JSON.stringify(result.options, null, 2));
                }
                var expectedOptions = JSON.parse(fs.readFileSync(expectedOptionsFileName, 'utf-8'));
                assert.deepEqual(assert._expr(assert._capt(expectedOptions, 'arguments/0'), {
                    content: 'assert.deepEqual(expectedOptions, result.options)',
                    filepath: 'tests/mainTest.js',
                    line: 98
                }), assert._expr(assert._capt(assert._capt(result, 'arguments/1/object').options, 'arguments/1'), {
                    content: 'assert.deepEqual(expectedOptions, result.options)',
                    filepath: 'tests/mainTest.js',
                    line: 98
                }));
                var tslintConfigName = path.dirname(fileName) + '/tslint.json';
                if (!fs.existsSync(tslintConfigName)) {
                    done();
                    return;
                }
                if (fileName === './tests/fixture/tslint/indent/main.ts') {
                    done();
                    return;
                }
                Q.all([
                    checkByTslint(tslintConfigName, fileName, true),
                    checkByTslint(tslintConfigName, expectedTsFileName, false)
                ]).catch(function (errorMsg) {
                    assert(false, errorMsg);
                }).finally(function () {
                    done();
                }).done();
            });
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3RzL21haW5UZXN0LmpzIl0sIm5hbWVzIjpbImFzc2VydCIsInJlcXVpcmUiLCJRIiwiZnMiLCJwYXRoIiwiY2hpbGRQcm9jZXNzIiwibGliIiwiY29sbGVjdEZpbGVOYW1lIiwiZGlyTmFtZSIsImZpbGVOYW1lIiwicmVhZGRpclN5bmMiLCJmb3JFYWNoIiwibmFtZSIsIm5ld05hbWUiLCJzdGF0cyIsInN0YXRTeW5jIiwiaXNEaXJlY3RvcnkiLCJjb25jYXQiLCJpc0ZpbGUiLCJwdXNoIiwiY2hlY2tCeVRzbGludCIsImNvbmZpZ0ZpbGVOYW1lIiwidHNmaWxlTmFtZSIsImVycm9yRXhwZWN0ZWQiLCJkIiwiZGVmZXIiLCJwcm9jZXNzIiwic3Bhd24iLCJzdGRvdXQiLCJvbiIsImRhdGEiLCJ0b1N0cmluZyIsInN0ZGVyciIsImNvZGUiLCJzdWNjZXNzIiwiYWN0aW9uIiwicmVzb2x2ZSIsInJlamVjdCIsInByb21pc2UiLCJkZXNjcmliZSIsImZpeHR1cmVEaXIiLCJleHBlY3RlZERpciIsImZpbGVOYW1lcyIsImZpbHRlciIsInRlc3QiLCJpdCIsImRvbmUiLCJyZXN1bHRNYXAiLCJwcm9jZXNzRmlsZXMiLCJkcnlSdW4iLCJyZXBsYWNlIiwidHNsaW50IiwiZWRpdG9yY29uZmlnIiwidHNmbXQiLCJyZXN1bHQiLCJfZXhwciIsIl9jYXB0IiwiY29udGVudCIsImZpbGVwYXRoIiwibGluZSIsImV4cGVjdGVkVHNGaWxlTmFtZSIsImV4aXN0c1N5bmMiLCJ3cml0ZUZpbGVTeW5jIiwiZGVzdCIsImV4cGVjdGVkIiwicmVhZEZpbGVTeW5jIiwiZXhwZWN0ZWRPcHRpb25zRmlsZU5hbWUiLCJKU09OIiwic3RyaW5naWZ5Iiwib3B0aW9ucyIsImV4cGVjdGVkT3B0aW9ucyIsInBhcnNlIiwiZGVlcEVxdWFsIiwidHNsaW50Q29uZmlnTmFtZSIsImRpcm5hbWUiLCJhbGwiLCJjYXRjaCIsImVycm9yTXNnIiwiZmluYWxseSJdLCJtYXBwaW5ncyI6IkFB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ZCxDQUFMLEVBQXNDO0FBQUEsb0JBQ2xDM0IsSUFBQSxHQURrQztBQUFBLG9CQUVsQyxPQUZrQztBQUFBLGlCQTlCYjtBQUFBLGdCQWtDekIsSUFBSXJDLFFBQUEsS0FBYSx1Q0FBakIsRUFBMEQ7QUFBQSxvQkFDdERxQyxJQUFBLEdBRHNEO0FBQUEsb0JBRXRELE9BRnNEO0FBQUEsaUJBbENqQztBQUFBLGdCQXVDekI1QyxDQUFBLENBQUV5RSxHQUFGLENBQU07QUFBQSxvQkFDRnZELGFBQUEsQ0FBY3FELGdCQUFkLEVBQWdDaEUsUUFBaEMsRUFBMEMsSUFBMUMsQ0FERTtBQUFBLG9CQUVGVyxhQUFBLENBQWNxRCxnQkFBZCxFQUFnQ2Isa0JBQWhDLEVBQW9ELEtBQXBELENBRkU7QUFBQSxpQkFBTixFQUdHZ0IsS0FISCxDQUdTLFVBQVVDLFFBQVYsRUFBb0I7QUFBQSxvQkFDekI3RSxNQUFBLENBQU8sS0FBUCxFQUFjNkUsUUFBZCxFQUR5QjtBQUFBLGlCQUg3QixFQUtHQyxPQUxILENBS1csWUFBWTtBQUFBLG9CQUNuQmhDLElBQUEsR0FEbUI7QUFBQSxpQkFMdkIsRUFPR0EsSUFQSCxHQXZDeUI7QUFBQSxhQUE3QixFQUQyQjtBQUFBLFNBRi9CLEVBRjBDO0FBQUEsS0FBOUMsRUFKK0I7QUFBQSxDQUFuQyIsInNvdXJjZXNDb250ZW50IjpbInZhciBhc3NlcnQgPSByZXF1aXJlKFwicG93ZXItYXNzZXJ0XCIpO1xudmFyIFEgPSByZXF1aXJlKFwicVwiKTtcblxudmFyIGZzID0gcmVxdWlyZShcImZzXCIpO1xudmFyIHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcbnZhciBjaGlsZFByb2Nlc3MgPSByZXF1aXJlKFwiY2hpbGRfcHJvY2Vzc1wiKTtcblxudmFyIGxpYiA9IHJlcXVpcmUoXCIuLi9saWIvbGliXCIpO1xuXG5mdW5jdGlvbiBjb2xsZWN0RmlsZU5hbWUoZGlyTmFtZSkge1xuICAgIHZhciBmaWxlTmFtZSA9IFtdO1xuICAgIGZzLnJlYWRkaXJTeW5jKGRpck5hbWUpLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHtcbiAgICAgICAgdmFyIG5ld05hbWUgPSBkaXJOYW1lICsgXCIvXCIgKyBuYW1lO1xuICAgICAgICB2YXIgc3RhdHMgPSBmcy5zdGF0U3luYyhuZXdOYW1lKTtcbiAgICAgICAgaWYgKHN0YXRzLmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgICAgIGZpbGVOYW1lID0gZmlsZU5hbWUuY29uY2F0KGNvbGxlY3RGaWxlTmFtZShuZXdOYW1lKSk7XG4gICAgICAgIH0gZWxzZSBpZiAoc3RhdHMuaXNGaWxlKCkpIHtcbiAgICAgICAgICAgIGZpbGVOYW1lLnB1c2gobmV3TmFtZSk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gZmlsZU5hbWU7XG59XG5cbmZ1bmN0aW9uIGNoZWNrQnlUc2xpbnQoY29uZmlnRmlsZU5hbWUsIHRzZmlsZU5hbWUsIGVycm9yRXhwZWN0ZWQpIHtcbiAgICB2YXIgZCA9IFEuZGVmZXIoKTtcbiAgICB2YXIgcHJvY2VzcyA9IGNoaWxkUHJvY2Vzcy5zcGF3bihcIi4vbm9kZV9tb2R1bGVzLy5iaW4vdHNsaW50XCIsIFtcIi1jXCIsIGNvbmZpZ0ZpbGVOYW1lLCBcIi1mXCIsIHRzZmlsZU5hbWVdKTtcblxuICAgIHZhciBzdGRvdXQgPSAnJztcbiAgICBwcm9jZXNzLnN0ZG91dC5vbignZGF0YScsIGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgIHN0ZG91dCArPSBkYXRhLnRvU3RyaW5nKCk7XG4gICAgfSk7XG5cbiAgICB2YXIgc3RkZXJyID0gJyc7XG4gICAgcHJvY2Vzcy5zdGRlcnIub24oJ2RhdGEnLCBmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICBzdGRlcnIgKz0gZGF0YS50b1N0cmluZygpO1xuICAgIH0pO1xuXG4gICAgcHJvY2Vzcy5vbihcImV4aXRcIiwgZnVuY3Rpb24gKGNvZGUpIHtcbiAgICAgICAgdmFyIHN1Y2Nlc3MgPSAhY29kZTtcbiAgICAgICAgdmFyIGFjdGlvbjtcbiAgICAgICAgaWYgKCFlcnJvckV4cGVjdGVkKSB7XG4gICAgICAgICAgICBpZiAoc3VjY2Vzcykge1xuICAgICAgICAgICAgICAgIGFjdGlvbiA9IFwicmVzb2x2ZVwiO1xuICAgICAgICAgICAgICAgIGQucmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYWN0aW9uID0gXCJyZWplY3RcIjtcbiAgICAgICAgICAgICAgICBkLnJlamVjdCh0c2ZpbGVOYW1lICsgXCIgbXVzdCBiZSBhIGdvb2QgY29kZS5cXG5cIiArIHN0ZG91dCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoc3VjY2Vzcykge1xuICAgICAgICAgICAgICAgIGFjdGlvbiA9IFwicmVqZWN0XCI7XG4gICAgICAgICAgICAgICAgZC5yZWplY3QodHNmaWxlTmFtZSArIFwiIG11c3QgYmUgYSBiYWQgY29kZS5cIik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGFjdGlvbiA9IFwicmVzb2x2ZVwiO1xuICAgICAgICAgICAgICAgIGQucmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBkLnByb21pc2U7XG59XG5cbmRlc2NyaWJlKFwidHNmbXQgdGVzdFwiLCBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIGZpeHR1cmVEaXIgPSBcIi4vdGVzdHMvZml4dHVyZVwiO1xuICAgIHZhciBleHBlY3RlZERpciA9IFwiLi90ZXN0cy9leHBlY3RlZFwiO1xuXG4gICAgZGVzY3JpYmUoXCJwcm9jZXNzRmlsZXMgZnVuY3Rpb25cIiwgZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgZmlsZU5hbWVzID0gY29sbGVjdEZpbGVOYW1lKGZpeHR1cmVEaXIpO1xuICAgICAgICBmaWxlTmFtZXMuZmlsdGVyKGZ1bmN0aW9uIChmaWxlTmFtZSkge1xuICAgICAgICAgICAgcmV0dXJuIC9cXC50cyQvLnRlc3QoZmlsZU5hbWUpO1xuICAgICAgICB9KS5mb3JFYWNoKGZ1bmN0aW9uIChmaWxlTmFtZSkge1xuICAgICAgICAgICAgaXQoZmlsZU5hbWUsIGZ1bmN0aW9uIChkb25lKSB7XG4gICAgICAgICAgICAgICAgdmFyIHJlc3VsdE1hcCA9IGxpYi5wcm9jZXNzRmlsZXMoW2ZpbGVOYW1lXSwge1xuICAgICAgICAgICAgICAgICAgICBkcnlSdW46IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIHJlcGxhY2U6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICB0c2xpbnQ6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGVkaXRvcmNvbmZpZzogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgdHNmbXQ6IHRydWVcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gcmVzdWx0TWFwW2ZpbGVOYW1lXTtcbiAgICAgICAgICAgICAgICBhc3NlcnQocmVzdWx0ICE9PSBudWxsKTtcblxuICAgICAgICAgICAgICAgIHZhciBleHBlY3RlZFRzRmlsZU5hbWUgPSBmaWxlTmFtZS5yZXBsYWNlKGZpeHR1cmVEaXIsIGV4cGVjdGVkRGlyKTtcblxuICAgICAgICAgICAgICAgIGlmICghZnMuZXhpc3RzU3luYyhleHBlY3RlZFRzRmlsZU5hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoZXhwZWN0ZWRUc0ZpbGVOYW1lLCByZXN1bHQuZGVzdCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdmFyIGV4cGVjdGVkID0gZnMucmVhZEZpbGVTeW5jKGV4cGVjdGVkVHNGaWxlTmFtZSwgXCJ1dGYtOFwiKTtcbiAgICAgICAgICAgICAgICBhc3NlcnQoZXhwZWN0ZWQgPT09IHJlc3VsdC5kZXN0KTtcblxuICAgICAgICAgICAgICAgIHZhciBleHBlY3RlZE9wdGlvbnNGaWxlTmFtZSA9IGV4cGVjdGVkVHNGaWxlTmFtZS5yZXBsYWNlKC9cXC50cyQvLCBcIi5qc29uXCIpO1xuXG4gICAgICAgICAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKGV4cGVjdGVkT3B0aW9uc0ZpbGVOYW1lKSkge1xuICAgICAgICAgICAgICAgICAgICBmcy53cml0ZUZpbGVTeW5jKGV4cGVjdGVkT3B0aW9uc0ZpbGVOYW1lLCBKU09OLnN0cmluZ2lmeShyZXN1bHQub3B0aW9ucywgbnVsbCwgMikpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHZhciBleHBlY3RlZE9wdGlvbnMgPSBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhleHBlY3RlZE9wdGlvbnNGaWxlTmFtZSwgXCJ1dGYtOFwiKSk7XG4gICAgICAgICAgICAgICAgYXNzZXJ0LmRlZXBFcXVhbChleHBlY3RlZE9wdGlvbnMsIHJlc3VsdC5vcHRpb25zKTtcblxuICAgICAgICAgICAgICAgIHZhciB0c2xpbnRDb25maWdOYW1lID0gcGF0aC5kaXJuYW1lKGZpbGVOYW1lKSArIFwiL3RzbGludC5qc29uXCI7XG4gICAgICAgICAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKHRzbGludENvbmZpZ05hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZmlsZU5hbWUgPT09IFwiLi90ZXN0cy9maXh0dXJlL3RzbGludC9pbmRlbnQvbWFpbi50c1wiKSB7XG4gICAgICAgICAgICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIFEuYWxsKFtcbiAgICAgICAgICAgICAgICAgICAgY2hlY2tCeVRzbGludCh0c2xpbnRDb25maWdOYW1lLCBmaWxlTmFtZSwgdHJ1ZSksXG4gICAgICAgICAgICAgICAgICAgIGNoZWNrQnlUc2xpbnQodHNsaW50Q29uZmlnTmFtZSwgZXhwZWN0ZWRUc0ZpbGVOYW1lLCBmYWxzZSlcbiAgICAgICAgICAgICAgICBdKS5jYXRjaChmdW5jdGlvbiAoZXJyb3JNc2cpIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0KGZhbHNlLCBlcnJvck1zZyk7XG4gICAgICAgICAgICAgICAgfSkuZmluYWxseShmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgICAgICAgICB9KS5kb25lKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59KTtcbiJdfQ==
